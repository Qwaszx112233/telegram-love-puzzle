<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>‚ù§Ô∏è Love Number Puzzle ‚ù§Ô∏è</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --primary-color: #e91e63;
      --secondary-color: #ff4081;
      --accent-color: #f8bbd9;
      --bg-color: #fff5f7;
      --text-color: #880e4f;
      --white: #ffffff;
      --shadow: 0 4px 15px rgba(233, 30, 99, 0.15);
      --cell-color: #ffeef2;
      --tg-color: #0088cc;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(135deg, #fff5f7 0%, #ffeef2 100%);
      margin: 0;
      padding: 10px;
      min-height: 100vh;
      width: 100%;
      overflow: hidden;
      touch-action: manipulation;
    }

    .tg-header {
      background: linear-gradient(45deg, var(--tg-color), #00a2ff);
      color: white;
      padding: 12px;
      text-align: center;
      font-weight: bold;
      border-radius: 12px;
      margin-bottom: 10px;
      box-shadow: var(--shadow);
      font-size: 1.1em;
    }

    .screen {
      width: 100%;
      height: calc(100vh - 80px);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 10px;
      transition: opacity 0.3s ease, transform 0.3s ease;
      overflow: hidden;
    }

    .screen.hidden {
      opacity: 0;
      pointer-events: none;
      transform: translateY(20px);
    }

    /* Main Menu Styles */
    .main-menu {
      text-align: center;
      padding: 20px 15px;
    }

    .game-title {
      font-size: clamp(1.8rem, 8vw, 2.5rem);
      font-weight: bold;
      color: var(--primary-color);
      margin-bottom: clamp(20px, 6vh, 30px);
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
      animation: heartbeat 2s ease-in-out infinite;
    }

    @keyframes heartbeat {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .menu-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
      width: 100%;
      max-width: 280px;
    }

    .menu-btn {
      padding: clamp(14px, 4vh, 18px) 20px;
      background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
      color: var(--white);
      border: none;
      border-radius: 15px;
      font-size: clamp(1rem, 4vw, 1.3rem);
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }

    .menu-btn:active {
      transform: scale(0.95);
    }

    .menu-btn.secondary {
      background: var(--white);
      color: var(--primary-color);
      border: 3px solid var(--accent-color);
    }

    .menu-btn.tg {
      background: linear-gradient(45deg, var(--tg-color), #00a2ff);
    }

    .menu-features {
      margin-top: clamp(20px, 5vh, 30px);
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      max-width: 300px;
    }

    .feature-item {
      background: var(--white);
      padding: 12px 8px;
      border-radius: 10px;
      box-shadow: var(--shadow);
      text-align: center;
      font-size: clamp(0.7rem, 3vw, 0.9rem);
      color: var(--text-color);
      font-weight: 600;
    }

    /* Game Screen Styles */
    .game-screen {
      justify-content: flex-start;
      padding: 10px 10px 5px;
    }

    .game-header {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
      margin-bottom: 8px;
      position: relative;
    }

    .header-top {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px;
    }

    .header {
      font-size: clamp(1.2rem, 5vw, 1.6rem);
      font-weight: bold;
      color: var(--primary-color);
      text-align: center;
      flex: 1;
    }

    .home-btn {
      padding: 8px 12px;
      background: var(--white);
      color: var(--primary-color);
      border: 2px solid var(--accent-color);
      border-radius: 8px;
      font-size: clamp(0.9rem, 4vw, 1.1rem);
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: var(--shadow);
      z-index: 10;
    }

    .home-btn:active {
      transform: scale(0.95);
    }

    .love-message {
      background: var(--white);
      padding: 8px 10px;
      border-radius: 10px;
      box-shadow: var(--shadow);
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid var(--accent-color);
      width: 100%;
    }

    .message-text {
      font-size: clamp(0.9rem, 3.5vw, 1.1rem);
      font-weight: 600;
      color: var(--text-color);
      line-height: 1.2;
      text-align: center;
    }

    .stats {
      display: flex;
      justify-content: space-around;
      width: 100%;
      margin: 5px 0;
      gap: 5px;
    }

    .stat-item {
      text-align: center;
      background: var(--white);
      padding: 5px 8px;
      border-radius: 8px;
      box-shadow: var(--shadow);
      font-size: clamp(0.7rem, 2.5vw, 0.85rem);
      font-weight: 600;
      color: var(--text-color);
      flex: 1;
    }

    .xp-bar {
      width: 100%;
      height: 12px;
      background: #ffeef2;
      border-radius: 6px;
      margin: 5px 0;
      overflow: hidden;
      position: relative;
      border: 2px solid var(--accent-color);
    }

    .xp-bar-inner {
      height: 100%;
      background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
      border-radius: 4px;
      transition: width 0.5s ease;
      position: relative;
      overflow: hidden;
    }

    .xp-bar-text {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.6rem;
      font-weight: bold;
      color: var(--text-color);
    }

    .game-content {
      width: 100%;
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0;
      gap: 8px;
    }

    .bonuses {
      display: flex;
      gap: 5px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .bonus-btn {
      padding: 6px 8px;
      font-size: clamp(0.7rem, 2.5vw, 0.8rem);
      border-radius: 6px;
      border: none;
      background: var(--cell-color);
      color: var(--text-color);
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 60px;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 2px;
      border: 2px solid var(--accent-color);
    }

    .bonus-btn:active:not(:disabled) {
      transform: scale(0.95);
    }

    .bonus-btn:disabled {
      background: #f8f8f8;
      color: #ccc;
      cursor: not-allowed;
      border-color: #f8f8f8;
    }

    .bonus-btn.active {
      background: var(--primary-color);
      color: var(--white);
    }

    .bonus-cost {
      color: var(--primary-color);
      font-weight: bold;
      font-size: 0.6rem;
    }

    .level-select {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      justify-content: center;
      margin: 3px 0;
      max-height: 60px;
      overflow-y: auto;
    }

    .level-btn {
      padding: 5px 0;
      width: clamp(28px, 7vw, 32px);
      border-radius: 6px;
      border: 2px solid var(--accent-color);
      background: var(--cell-color);
      color: var(--text-color);
      font-weight: bold;
      font-size: clamp(0.6rem, 2vw, 0.7rem);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .level-btn.selected, .level-btn:active {
      background: var(--primary-color);
      color: var(--white);
      border-color: var(--primary-color);
    }

    .grid-container {
      flex: 1;
      min-height: 0;
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      max-height: 50vh;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      grid-template-rows: repeat(8, 1fr);
      gap: 2px;
      background: var(--white);
      border-radius: 10px;
      box-shadow: var(--shadow);
      padding: 5px;
      width: 100%;
      max-width: 400px;
      height: 100%;
      max-height: 100%;
      touch-action: none;
      user-select: none;
    }

    .cell {
      position: relative;
      background: var(--cell-color);
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(233, 30, 99, 0.1);
      transition: all 0.2s ease;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      border: 1px solid transparent;
    }

    .cell::before {
      content: '';
      display: block;
      padding-top: 100%;
    }

    .cell-inner {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: clamp(0.7rem, 2vw, 0.9rem);
      font-weight: bold;
      color: var(--text-color);
      user-select: none;
      pointer-events: none;
      transition: all 0.2s ease;
    }

    .cell.selected {
      transform: scale(0.95);
      border-color: var(--secondary-color);
    }

    .cell.merged .cell-inner {
      background: var(--primary-color);
      color: var(--white);
      border-radius: 5px;
      animation: pop 0.3s ease;
    }

    @keyframes pop {
      0% { transform: scale(1.2); opacity: 0.8; }
      100% { transform: scale(1); opacity: 1; }
    }

    .cell.valid-next {
      box-shadow: 0 0 0 2px var(--secondary-color);
    }

    /* –ö–æ–ª—å–æ—Ä–∏ –¥–ª—è —Ä—ñ–∑–Ω–∏—Ö —á–∏—Å–µ–ª */
    .cell[data-number="2"] { background: #ffb6c1; }
    .cell[data-number="4"] { background: #ffd700; }
    .cell[data-number="8"] { background: #98fb98; }
    .cell[data-number="16"] { background: #87ceeb; }
    .cell[data-number="32"] { background: #da70d6; }
    .cell[data-number="64"] { background: #ffa07a; }
    .cell[data-number="128"] { background: #f0e68c; }
    .cell[data-number="256"] { background: #dda0dd; }
    .cell[data-number="512"] { background: #b0e0e6; }
    .cell[data-number="1024"] { background: #ffb347; }
    .cell[data-number="2048"] { background: #c9a0dc; }
    .cell[data-number="4096"] { background: #77dd77; }
    .cell[data-number="8192"] { background: #ff6961; }
    .cell[data-number="16384"] { background: #aec6cf; }
    .cell[data-number="32768"] { background: #f49ac2; }
    .cell[data-number="65536"] { background: #cb99c9; }
    .cell[data-number="131072"] { background: #ffb6c1; }
    .cell[data-number="262144"] { background: #ffd700; }
    .cell[data-number="524288"] { background: #98fb98; }
    .cell[data-number="1048576"] { background: #87ceeb; }
    .cell[data-number="2097152"] { background: #da70d6; }
    .cell[data-number="4194304"] { background: #ffa07a; }
    .cell[data-number="8388608"] { background: #f0e68c; }
    .cell[data-number="16777216"] { background: #dda0dd; }
    .cell[data-number="33554432"] { background: #b0e0e6; }
    .cell[data-number="67108864"] { background: #ffb347; }
    .cell[data-number="134217728"] { background: #c9a0dc; }
    .cell[data-number="268435456"] { background: #77dd77; }
    .cell[data-number="536870912"] { background: #ff6961; }
    .cell[data-number="1073741824"] { background: #aec6cf; }

    .controls {
      display: flex;
      gap: 6px;
      justify-content: center;
      flex-wrap: wrap;
      margin: 8px 0 5px;
      width: 100%;
      padding: 10px 5px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      box-shadow: var(--shadow);
      border: 2px solid var(--accent-color);
      min-height: 60px;
      align-items: center;
    }

    .btn {
      padding: 10px 12px;
      background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
      color: var(--white);
      border: none;
      border-radius: 8px;
      font-size: clamp(0.8rem, 3vw, 0.9rem);
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: var(--shadow);
      flex: 1;
      min-width: 80px;
    }

    .btn:active {
      transform: scale(0.95);
    }

    .btn.back-btn {
      background: var(--white);
      color: var(--primary-color);
      border: 2px solid var(--accent-color);
    }

    .btn.tg-btn {
      background: linear-gradient(45deg, var(--tg-color), #00a2ff);
    }

    .hearts {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }

    .heart {
      position: absolute;
      font-size: 0.8rem;
      opacity: 0;
      animation: float 2s ease-in-out forwards;
    }

    @keyframes float {
      0% { transform: translateY(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(-30px) rotate(360deg); opacity: 0; }
    }

    .fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .floating-hearts {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: -1;
    }

    .floating-heart {
      position: absolute;
      font-size: 1rem;
      opacity: 0.1;
      animation: floatAround 10s linear infinite;
    }

    @keyframes floatAround {
      0% { transform: translate(0, 0) rotate(0deg); }
      25% { transform: translate(100px, 100px) rotate(90deg); }
      50% { transform: translate(50px, 200px) rotate(180deg); }
      75% { transform: translate(-50px, 150px) rotate(270deg); }
      100% { transform: translate(0, 0) rotate(360deg); }
    }

    /* Victory Screen */
    .victory-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .victory-overlay.hidden {
      display: none;
    }

    .victory-content {
      background: var(--white);
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(233, 30, 99, 0.3);
      text-align: center;
      max-width: 90%;
    }

    .victory-title {
      font-size: clamp(1.8rem, 8vw, 2.5rem);
      color: var(--primary-color);
      margin-bottom: 20px;
    }

    .victory-message {
      font-size: clamp(1rem, 4vw, 1.2rem);
      color: var(--text-color);
      margin-bottom: 30px;
    }

    /* Settings Screen */
    .settings-screen {
      text-align: center;
      padding: 20px 15px;
    }

    .settings-title {
      font-size: clamp(1.5rem, 6vw, 2rem);
      color: var(--primary-color);
      margin-bottom: clamp(20px, 5vh, 30px);
    }

    .settings-options {
      display: flex;
      flex-direction: column;
      gap: 15px;
      width: 100%;
      max-width: 300px;
    }

    .setting-item {
      background: var(--white);
      padding: 12px;
      border-radius: 10px;
      box-shadow: var(--shadow);
      text-align: left;
    }

    .setting-label {
      font-weight: bold;
      color: var(--text-color);
      margin-bottom: 6px;
      display: block;
      font-size: clamp(0.9rem, 3vw, 1rem);
    }

    .setting-control {
      width: 100%;
      padding: 8px;
      border: 2px solid var(--accent-color);
      border-radius: 8px;
      font-size: clamp(0.9rem, 3vw, 1rem);
      background: var(--white);
    }

    /* Landscape orientation support */
    @media (max-height: 500px) and (orientation: landscape) {
      .game-screen {
        padding: 5px 5px 3px;
      }
      
      .game-header {
        flex-direction: row;
        flex-wrap: wrap;
        gap: 3px;
        margin-bottom: 3px;
      }
      
      .header-top {
        width: 100%;
        margin-bottom: 0;
      }
      
      .love-message {
        min-height: 40px;
        flex: 2;
      }
      
      .stats {
        flex: 1;
        margin: 0;
      }
      
      .xp-bar {
        margin: 2px 0;
      }
      
      .grid-container {
        max-height: 45vh;
      }
      
      .controls {
        margin: 5px 0 2px;
        padding: 8px 5px;
        min-height: 50px;
      }
      
      .level-select {
        max-height: 40px;
      }
    }

    @media (max-width: 320px) {
      .menu-buttons {
        max-width: 250px;
      }
      
      .bonus-btn {
        min-width: 55px;
        padding: 5px 6px;
      }
      
      .btn {
        min-width: 70px;
        padding: 8px 10px;
      }
      
      .victory-content {
        padding: 20px;
      }
      
      .level-btn {
        width: 26px;
        font-size: 0.6rem;
      }
    }

    /* Mobile-specific improvements */
    @media (max-width: 480px) {
      .controls {
        position: relative;
        z-index: 100;
        margin: 8px 0 5px;
      }
      
      .btn {
        padding: 10px 8px;
        font-size: 0.8rem;
      }
      
      .home-btn {
        padding: 6px 10px;
        font-size: 0.9rem;
      }
    }

    /* Very small screens */
    @media (max-height: 600px) {
      .game-content {
        gap: 5px;
      }
      
      .grid-container {
        max-height: 45vh;
      }
      
      .controls {
        margin: 5px 0 3px;
        padding: 8px 4px;
        min-height: 55px;
      }
    }

    /* Extra small height screens */
    @media (max-height: 650px) {
      .game-screen {
        padding: 8px 10px 3px;
      }
      
      .grid-container {
        max-height: 48vh;
      }
    }

    /* –î–ª—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ - —É–º–µ–Ω—å—à–∞–µ–º —Å–µ—Ç–∫—É */
    @media (max-height: 500px) {
      .grid {
        grid-template-rows: repeat(8, 1fr);
        gap: 1px;
        padding: 3px;
      }
      
      .cell-inner {
        font-size: clamp(0.6rem, 1.5vw, 0.8rem);
      }
    }
  </style>
</head>
<body>
  <!-- Telegram Header -->
  <div class="tg-header" id="tgHeader">
    üíñ Love Puzzle - –ò–≥—Ä–∞–π —Å –ª—é–±–æ–≤—å—é!
  </div>
  
  <!-- Floating Hearts Background -->
  <div class="floating-hearts" id="floatingHearts"></div>
  
  <!-- Victory Overlay -->
  <div class="victory-overlay hidden" id="victoryOverlay">
    <div class="victory-content">
      <div class="victory-title">üéâ –í—ñ—Ç–∞—é! üéâ</div>
      <div class="victory-message" id="victoryMessage">–¢–∏ –ø—Ä–æ–π—à–ª–∞ –≤—Å—ñ —Ä—ñ–≤–Ω—ñ! –¢–∏ –Ω–∞–π–∫—Ä–∞—â–∞! üíù</div>
      <div class="menu-buttons">
        <button class="menu-btn tg-btn" id="shareBtn">üì§ –ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è</button>
        <button class="menu-btn" id="playAgainBtn">üîÑ –ì—Ä–∞—Ç–∏ –∑–Ω–æ–≤—É</button>
        <button class="menu-btn secondary" id="backToMenuBtn">üè† –ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é</button>
      </div>
    </div>
  </div>
  
  <!-- Main Menu Screen -->
  <div class="screen" id="mainMenuScreen">
    <div class="game-title">‚ù§Ô∏è Love Puzzle ‚ù§Ô∏è</div>
    <div class="menu-buttons">
      <button class="menu-btn" id="playBtn">üéÆ –ì—Ä–∞—Ç–∏</button>
      <button class="menu-btn tg-btn" id="tgMenuBtn">üì± –í Telegram</button>
      <button class="menu-btn secondary" id="settingsBtn">‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</button>
      <button class="menu-btn secondary" id="aboutBtn">‚ÑπÔ∏è –ü—Ä–æ –≥—Ä—É</button>
    </div>
    <div class="menu-features">
      <div class="feature-item">üíñ –Ø —Ç–µ–±–µ</div>
      <div class="feature-item">–ª—é–±–∞—é</div>
      <div class="feature-item">—à–æ –∞–∂</div>
      <div class="feature-item">–∫–æ—Ö–∞—é üíñ</div>
    </div>
  </div>
  
  <!-- Game Screen -->
  <div class="screen game-screen hidden" id="gameScreen">
    <div class="game-header">
      <div class="header-top">
        <button class="home-btn" id="homeBtn">üè†</button>
        <div class="header">–°–æ–Ω–µ—á–∫–æ, —è —Ç–µ–±–µ –∫–æ—Ö–∞—é ‚ù§Ô∏è</div>
      </div>
      <div class="love-message">
        <div class="hearts" id="hearts"></div>
        <div class="message-text" id="messageText">–û–±'—î–¥–Ω—É–π —á–∏—Å–ª–∞ —Ç–∞ –æ—Ç—Ä–∏–º—É–π –ª—é–±–æ–≤–Ω—ñ —Ñ—Ä–∞–∑–∏! üíï</div>
      </div>
      <div class="stats">
        <div class="stat-item">–†—ñ–≤–µ–Ω—å: <span id="currentLevel">1</span>/30</div>
        <div class="stat-item">–¶—ñ–ª—å: <span id="targetValue">64</span></div>
        <div class="stat-item">–§—Ä–∞–∑: <span id="messageCount">0</span></div>
      </div>
    </div>
    
    <div class="xp-bar">
      <div class="xp-bar-inner" id="xpBar">
        <div class="xp-bar-text" id="xpText">0/10</div>
      </div>
    </div>
    
    <div class="game-content">
      <div class="bonuses">
        <button class="bonus-btn" id="bonus-destroy">
          üíñ –†–æ–∑–±–∏—Ç–∏ <span class="bonus-cost">5</span>
        </button>
        <button class="bonus-btn" id="bonus-shuffle">
          üîÑ –ü–µ—Ä–µ–º—ñ—à–∞—Ç–∏ <span class="bonus-cost">10</span>
        </button>
        <button class="bonus-btn" id="bonus-explosion">
          üí• –í–∏–±—É—Ö 3√ó3 <span class="bonus-cost">20</span>
        </button>
      </div>
      
      <div class="level-select" id="level-select"></div>
      
      <div class="grid-container">
        <div class="grid" id="grid"></div>
      </div>
      
      <div class="controls">
        <button class="btn back-btn" id="backBtn">‚Üê –ù–∞–∑–∞–¥</button>
        <button class="btn" id="resetBtn">üîÑ –°–∫–∏–Ω—É—Ç–∏</button>
        <button class="btn tg-btn" id="saveBtn">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
        <button class="btn" id="nextLevelBtn">‚≠ê –î–∞–ª—ñ</button>
      </div>
    </div>
  </div>
  
  <!-- Settings Screen -->
  <div class="screen settings-screen hidden" id="settingsScreen">
    <div class="settings-title">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è ‚öôÔ∏è</div>
    <div class="settings-options">
      <div class="setting-item">
        <label class="setting-label">–°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å:</label>
        <select class="setting-control" id="difficultySelect">
          <option value="easy">–õ–µ–≥–∫–∞</option>
          <option value="medium" selected>–°–µ—Ä–µ–¥–Ω—è</option>
          <option value="hard">–°–∫–ª–∞–¥–Ω–∞</option>
        </select>
      </div>
      <div class="setting-item">
        <label class="setting-label">–ó–≤—É–∫–∏:</label>
        <select class="setting-control" id="soundSelect">
          <option value="on" selected>–£–≤—ñ–º–∫–Ω–µ–Ω–æ</option>
          <option value="off">–í–∏–º–∫–Ω–µ–Ω–æ</option>
        </select>
      </div>
      <div class="setting-item">
        <label class="setting-label">–ê–Ω—ñ–º–∞—Ü—ñ—ó:</label>
        <select class="setting-control" id="animationSelect">
          <option value="on" selected>–£–≤—ñ–º–∫–Ω–µ–Ω–æ</option>
          <option value="off">–í–∏–º–∫–Ω–µ–Ω–æ</option>
        </select>
      </div>
    </div>
    <div class="menu-buttons" style="margin-top: 20px;">
      <button class="menu-btn tg-btn" id="saveSettingsBtn">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
      <button class="menu-btn secondary" id="backFromSettingsBtn">‚Üê –ù–∞–∑–∞–¥</button>
    </div>
  </div>
  
  <!-- About Screen -->
  <div class="screen settings-screen hidden" id="aboutScreen">
    <div class="settings-title">–ü—Ä–æ –≥—Ä—É ‚ÑπÔ∏è</div>
    <div class="settings-options">
      <div class="setting-item" style="text-align: center;">
        <h3 style="font-size: clamp(1.1rem, 4vw, 1.3rem); margin-bottom: 10px;">Love Number Puzzle</h3>
        <p style="margin: 8px 0; line-height: 1.3; font-size: clamp(0.8rem, 3vw, 0.9rem);">
          –ü–æ—î–¥–Ω—É–π—Ç–µ —á–∏—Å–ª–∞ —Ç–∞ –æ—Ç—Ä–∏–º—É–π—Ç–µ –ª—é–±–æ–≤–Ω—ñ —Ñ—Ä–∞–∑–∏! üíï<br>
          –û–±'—î–¥–Ω—É–π—Ç–µ –æ–¥–Ω–∞–∫–æ–≤—ñ —á–∏—Å–ª–∞ –∞–±–æ —á–∏—Å–ª–∞, —â–æ –≤—ñ–¥—Ä—ñ–∑–Ω—è—é—Ç—å—Å—è –≤–¥–≤—ñ—á—ñ.
        </p>
        <p style="margin: 8px 0; line-height: 1.3; font-size: clamp(0.8rem, 3vw, 0.9rem);">
          ‚ú® –û—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ:<br>
          ‚Ä¢ 30 —Ä—ñ–≤–Ω—ñ–≤ —Å–∫–ª–∞–¥–Ω–æ—Å—Ç—ñ<br>
          ‚Ä¢ –õ—é–±–æ–≤–Ω—ñ —Ñ—Ä–∞–∑–∏ —Ç–∞ –∞–Ω—ñ–º–∞—Ü—ñ—ó<br>
          ‚Ä¢ –ë–æ–Ω—É—Å–∏ —Ç–∞ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ<br>
          ‚Ä¢ –Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –∑ Telegram<br>
        </p>
        <p style="margin: 8px 0; line-height: 1.3; font-size: clamp(0.8rem, 3vw, 0.9rem);">
          üéÆ –ö–µ—Ä—É–≤–∞–Ω–Ω—è:<br>
          ‚Ä¢ –¢–æ—Ä–∫–∞–π—Ç–µ—Å—è –∫–ª—ñ—Ç–∏–Ω–æ–∫ –¥–ª—è –≤–∏–±–æ—Ä—É<br>
          ‚Ä¢ –û–±'—î–¥–Ω—É–π—Ç–µ –≤ –ª–∞–Ω—Ü—é–∂–∫–∏<br>
          ‚Ä¢ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –±–æ–Ω—É—Å–∏
        </p>
      </div>
    </div>
    <div class="menu-buttons" style="margin-top: 20px;">
      <button class="menu-btn tg-btn" id="tgBotBtn">ü§ñ –ù–∞—à –±–æ—Ç</button>
      <button class="menu-btn secondary" id="backFromAboutBtn">‚Üê –ù–∞–∑–∞–¥</button>
    </div>
  </div>

  <script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
    let tg = window.Telegram?.WebApp;
    
    class LoveNumberPuzzle {
      constructor() {
        this.tg = tg;
        this.isTelegram = !!tg;
        
        if (this.isTelegram) {
          tg.expand();
          tg.enableClosingConfirmation();
          this.setupTelegramIntegration();
        }
        
        this.levels = this.generateLevels(30);
        this.MAX_LEVEL = this.levels.length;
        
        this.loveMessages = [
          "–¢–∏ - –º–æ—î —Å–æ–Ω–µ—á–∫–æ, —â–æ –æ—Å–≤—ñ—Ç–ª—é—î –∫–æ–∂–µ–Ω –º—ñ–π –¥–µ–Ω—å üåû",
          "–ö–æ—Ö–∞–Ω–Ω—è –¥–æ —Ç–µ–±–µ –∑ –∫–æ–∂–Ω–∏–º –¥–Ω–µ–º —Å—Ç–∞—î —Å–∏–ª—å–Ω—ñ—à–∏–º üíñ",
          "–¢–≤–æ—ó –æ—á—ñ - —Ü–µ –∑—ñ—Ä–∫–∏, —â–æ –≤–∫–∞–∑—É—é—Ç—å –º–µ–Ω—ñ —à–ª—è—Ö ‚ú®",
          "–ó —Ç–æ–±–æ—é –∫–æ–∂–Ω–∞ –º–∏—Ç—å - —Ü–µ –∫–∞–∑–∫–∞ üè∞",
          "–¢–∏ - –Ω–∞–π–Ω—ñ–∂–Ω—ñ—à–∞ –º—Ä—ñ—è –º–æ—î—ó –¥—É—à—ñ üí≠",
          "–¢–≤–æ—ó –æ–±—ñ–π–º–∏ - –º—ñ–π —É–ª—é–±–ª–µ–Ω–∏–π –∑–∞—Ö–∏—Å—Ç ü§ó",
          "–ö–æ–∂–Ω–∞ —á–∞—Å—Ç–∏–Ω–∫–∞ —Ç–µ–±–µ —á–∞—Ä—ñ–≤–Ω–∞ ü™Ñ",
          "–¢–∏ —Ä–æ–±–∏—à –º–æ—î –∂–∏—Ç—Ç—è —Å–æ–ª–æ–¥—à–∏–º üçØ",
          "–¢–∏ - –º–æ—è —É–ª—é–±–ª–µ–Ω–∞ –ø–∞–Ω–¥–∞ —Å–µ—Ä–µ–¥ —É—Å—ñ—Ö –ø–∞–Ω–¥ üêº",
          "–õ—é–±–ª—é —Ç–µ–±–µ —Å–∏–ª—å–Ω—ñ—à–µ, –Ω—ñ–∂ –∫–æ—Ç–∏ –ª—é–±–ª—è—Ç—å –∫–æ—Ä–æ–±–∫–∏ üì¶",
          "–¢–∏ - –º–æ—î —â–∞—Å—Ç—è, —è–∫ –º–æ—Ä–æ–∑–∏–≤–æ –≤ —Å–ø–µ–∫–æ—Ç–Ω–∏–π –¥–µ–Ω—å üç¶",
          "–¢–≤–æ—è –ø–æ—Å–º—ñ—à–∫–∞ - –Ω–∞–π–∫—Ä–∞—Å–∏–≤—ñ—à–∏–π –ø–µ–π–∑–∞–∂ üòä",
          "–õ—é–±–æ–≤ –¥–æ —Ç–µ–±–µ - –≤—ñ—á–Ω–∞ —ñ –±–µ–∑–º–µ–∂–Ω–∞ ‚ôæÔ∏è",
          "–¢–∏ - –º—ñ–π —Å–ø–æ–∫—ñ–π —Å–µ—Ä–µ–¥ –±—É—Ä—ñ üåä",
          "–ó —Ç–æ–±–æ—é —è –∑–Ω–∞–π—à–æ–≤ —Å–ø—Ä–∞–≤–∂–Ω—î —â–∞—Å—Ç—è ü•π",
          "–¢–≤–æ—î —Å–µ—Ä—Ü–µ - –º—ñ–π –Ω–∞–π—Ü—ñ–Ω–Ω—ñ—à–∏–π —Å–∫–∞—Ä–± üíé",
          "–ö–æ–∂–Ω–∞ –º–∏—Ç—å –∑ —Ç–æ–±–æ—é - —Ü–µ –ø–æ–¥–∞—Ä—É–Ω–æ–∫ üéÅ",
          "–¢–∏ —Ä–æ–±–∏—à –º–æ—î –∂–∏—Ç—Ç—è —è—Å–∫—Ä–∞–≤—ñ—à–∏–º üåà",
          "–ú–æ—î –∫–æ—Ö–∞–Ω–Ω—è –¥–æ —Ç–µ–±–µ –±–µ–∑–º–µ–∂–Ω–µ, —è–∫ –æ–∫–µ–∞–Ω üåä",
          "–¢–∏ - –ø—Ä–∏—á–∏–Ω–∞ –º–æ—î—ó –ø–æ—Å–º—ñ—à–∫–∏ –∫–æ–∂–Ω–æ–≥–æ –¥–Ω—è üòä",
          "–¢–≤–æ—è –ª—é–±–æ–≤ - –Ω–∞–π–∫—Ä–∞—â–µ, —â–æ —Å—Ç–∞–ª–æ—Å—è –≤ –º–æ—î–º—É –∂–∏—Ç—Ç—ñ üíù",
          "–ó —Ç–æ–±–æ—é —è –º–æ–∂—É –¥–æ—Å—è–≥—Ç–∏ –±—É–¥—å-—á–æ–≥–æ! üöÄ",
          "–¢–∏ - –º–æ—è –º—É–∑–∞ —Ç–∞ –Ω–∞—Ç—Ö–Ω–µ–Ω–Ω—è üé®",
          "–ö–æ–∂–µ–Ω –¥–µ–Ω—å –∑ —Ç–æ–±–æ—é - —Ü–µ –Ω–æ–≤–∞ –ø—Ä–∏–≥–æ–¥–∞ üó∫Ô∏è",
          "–¢–≤–æ—è –ø—Ä–∏—Å—É—Ç–Ω—ñ—Å—Ç—å —Ä–æ–±–∏—Ç—å –≤—Å–µ –∫—Ä–∞—â–∏–º ‚ú®",
          "–¢–∏ - –º–æ—è —Ç–∏—Ö–∞ –≥–∞–≤–∞–Ω—å —É –±—É—Ä—Ö–ª–∏–≤–æ–º—É –º–æ—Ä—ñ ‚öì",
          "–õ—é–±–ª—é —Ç–µ–±–µ –±—ñ–ª—å—à–µ, –Ω—ñ–∂ —Å–ª–æ–≤–∞ –º–æ–∂—É—Ç—å –ø–µ—Ä–µ–¥–∞—Ç–∏ üíå",
          "–¢–∏ - –º—ñ–π —â–∞—Å–ª–∏–≤–∏–π –∫–≤–∏—Ç–æ–∫ —É –∂–∏—Ç—Ç—ñ üé´",
          "–ó —Ç–æ–±–æ—é –∫–æ–∂–µ–Ω –¥–µ–Ω—å - —Å–≤—è—Ç–æ üéâ",
          "–¢–∏ - –≤—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–∞ –≤—Å—ñ –º–æ—ó –º–æ–ª–∏—Ç–≤–∏ üôè"
        ];
        
        this.GRID_W = 5;
        this.GRID_H = 8;
        this.bonusCosts = { destroy: 5, shuffle: 10, explosion: 20 };
        
        this.currentLevel = 0;
        this.grid = [];
        this.selected = [];
        this.isDragging = false;
        this.chainNumbers = [];
        this.xp = 0;
        this.xpToNext = 10;
        this.maxNumber = 8;
        this.activeBonus = null;
        this.gameState = 'playing';
        this.messageCount = 0;
        
        this.createFloatingHearts();
        this.initializeEventListeners();
        this.showScreen('mainMenu');
        this.loadGameState();
        
        document.addEventListener('dblclick', (e) => e.preventDefault());
      }
      
      setupTelegramIntegration() {
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram Web App
        this.tg.MainButton.setText("üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–≥—Ä—É").show();
        this.tg.MainButton.onClick(() => this.saveGameState());
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
        this.tg.onEvent('viewportChanged', () => {
          this.tg.expand();
        });
      }
      
      generateLevels(count) {
        const levels = [];
        let target = 64;
        let baseNumbers = [2, 4, 8];
        
        for (let i = 0; i < count; i++) {
          const level = {
            numbers: [...baseNumbers],
            target: target,
            newNumbers: this.generateNewNumbers(target),
            max: baseNumbers[baseNumbers.length - 1],
            xpToNext: 10 + Math.floor(i * 2.5)
          };
          
          levels.push(level);
          
          target *= 2;
          
          if (i % 3 === 2 && baseNumbers.length < 5) {
            baseNumbers.push(baseNumbers[baseNumbers.length - 1] * 2);
          }
          
          if (i >= 15 && baseNumbers.length < 6) {
            baseNumbers.push(baseNumbers[baseNumbers.length - 1] * 2);
          }
        }
        
        return levels;
      }
      
      generateNewNumbers(target) {
        const newNumbers = [];
        let num = target / 8;
        for (let i = 0; i < 8; i++) {
          if (num <= target) {
            newNumbers.push(num);
            num *= 2;
          }
        }
        return newNumbers;
      }
      
      createFloatingHearts() {
        const container = document.getElementById('floatingHearts');
        const heartCount = 12;
        
        for (let i = 0; i < heartCount; i++) {
          const heart = document.createElement('div');
          heart.className = 'floating-heart';
          heart.innerHTML = '‚ù§Ô∏è';
          heart.style.left = Math.random() * 100 + 'vw';
          heart.style.top = Math.random() * 100 + 'vh';
          heart.style.animationDelay = Math.random() * 5 + 's';
          heart.style.fontSize = (Math.random() * 0.8 + 0.8) + 'em';
          container.appendChild(heart);
        }
      }
      
      showScreen(screenName) {
        document.querySelectorAll('.screen').forEach(screen => {
          screen.classList.add('hidden');
        });
        
        const targetScreen = document.getElementById(screenName + 'Screen');
        if (targetScreen) {
          targetScreen.classList.remove('hidden');
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É Telegram
        if (this.isTelegram) {
          if (screenName === 'game') {
            this.tg.MainButton.setText("üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–≥—Ä—É").show();
          } else {
            this.tg.MainButton.hide();
          }
        }
      }
      
      showVictoryScreen() {
        const victoryOverlay = document.getElementById('victoryOverlay');
        const victoryMessage = document.getElementById('victoryMessage');
        
        victoryMessage.textContent = `–¢–∏ –ø—Ä–æ–π—à–ª–∞ –≤—Å—ñ ${this.MAX_LEVEL} —Ä—ñ–≤–Ω—ñ–≤! –¢–∏ –Ω–∞–π–∫—Ä–∞—â–∞! üíù`;
        victoryOverlay.classList.remove('hidden');
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Telegram
        if (this.isTelegram) {
          this.tg.sendData(JSON.stringify({
            action: 'game_completed',
            levels: this.MAX_LEVEL,
            messages: this.messageCount
          }));
        }
      }
      
      hideVictoryScreen() {
        const victoryOverlay = document.getElementById('victoryOverlay');
        victoryOverlay.classList.add('hidden');
      }
      
      initializeEventListeners() {
        // Main menu buttons
        document.getElementById('playBtn').addEventListener('click', () => {
          this.startGame();
        });
        
        document.getElementById('tgMenuBtn').addEventListener('click', () => {
          if (this.isTelegram) {
            this.tg.close();
          } else {
            this.showLoveMessage("–û—Ç–∫—Ä–æ–π –∏–≥—Ä—É —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞! ü§ñ");
          }
        });
        
        document.getElementById('settingsBtn').addEventListener('click', () => {
          this.showScreen('settings');
        });
        
        document.getElementById('aboutBtn').addEventListener('click', () => {
          this.showScreen('about');
        });
        
        // Home button in game screen
        document.getElementById('homeBtn').addEventListener('click', () => {
          this.showScreen('mainMenu');
        });
        
        // Back buttons
        document.getElementById('backBtn').addEventListener('click', () => {
          this.showScreen('mainMenu');
        });
        
        document.getElementById('backFromSettingsBtn').addEventListener('click', () => {
          this.showScreen('mainMenu');
        });
        
        document.getElementById('backFromAboutBtn').addEventListener('click', () => {
          this.showScreen('mainMenu');
        });
        
        // Telegram bot button
        document.getElementById('tgBotBtn').addEventListener('click', () => {
          if (this.isTelegram) {
            this.tg.openTelegramLink('https://t.me/YourBotUsername');
          } else {
            window.open('https://t.me/YourBotUsername', '_blank');
          }
        });
        
        // Victory screen buttons
        document.getElementById('playAgainBtn').addEventListener('click', () => {
          this.hideVictoryScreen();
          this.startGame();
        });
        
        document.getElementById('backToMenuBtn').addEventListener('click', () => {
          this.hideVictoryScreen();
          this.showScreen('mainMenu');
        });
        
        document.getElementById('shareBtn').addEventListener('click', () => {
          this.shareGame();
        });
        
        // Settings
        document.getElementById('saveSettingsBtn').addEventListener('click', () => {
          this.showScreen('mainMenu');
        });
        
        // Game buttons
        document.getElementById('resetBtn').addEventListener('click', () => this.resetGame());
        document.getElementById('nextLevelBtn').addEventListener('click', () => this.nextLevel());
        document.getElementById('saveBtn').addEventListener('click', () => this.saveGameState());
        
        document.getElementById('bonus-destroy').addEventListener('click', () => this.activateBonus('destroy'));
        document.getElementById('bonus-shuffle').addEventListener('click', () => this.activateBonus('shuffle'));
        document.getElementById('bonus-explosion').addEventListener('click', () => this.activateBonus('explosion'));
        
        document.addEventListener('contextmenu', e => e.preventDefault());
      }
      
      startGame() {
        this.initGame(0);
        this.showScreen('game');
      }
      
      initGame(levelNum = 0) {
        this.currentLevel = levelNum;
        const level = this.levels[this.currentLevel];
        
        this.xp = 0;
        this.xpToNext = level.xpToNext;
        this.maxNumber = level.max;
        this.selected = [];
        this.isDragging = false;
        this.chainNumbers = [];
        this.grid = [];
        this.activeBonus = null;
        this.gameState = 'playing';
        this.messageCount = 0;
        document.getElementById('messageCount').textContent = '0';
        
        for (let x = 0; x < this.GRID_W; x++) {
          this.grid[x] = [];
          for (let y = 0; y < this.GRID_H; y++) {
            this.grid[x][y] = { 
              number: level.numbers[Math.floor(Math.random() * level.numbers.length)], 
              merged: false 
            };
          }
        }
        
        this.render();
        this.updateInfo();
        this.showLoveMessage("–û–±'—î–¥–Ω—É–π —á–∏—Å–ª–∞ —Ç–∞ –æ—Ç—Ä–∏–º—É–π –ª—é–±–æ–≤–Ω—ñ —Ñ—Ä–∞–∑–∏! üíï");
        this.updateBonusButtons();
        this.showLevelSelect();
      }
      
      render() {
        const gridDiv = document.getElementById('grid');
        gridDiv.innerHTML = '';
        
        for (let y = 0; y < this.GRID_H; y++) {
          for (let x = 0; x < this.GRID_W; x++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.dataset.x = x;
            cell.dataset.y = y;
            cell.dataset.number = this.grid[x][y].number;
            
            if (this.selected.some(sel => sel.x === x && sel.y === y)) {
              cell.classList.add('selected');
            }
            
            if (this.grid[x][y].merged) {
              cell.classList.add('merged');
            }
            
            cell.addEventListener('mousedown', (e) => this.handleCellStart(e, x, y));
            cell.addEventListener('touchstart', (e) => this.handleCellStart(e, x, y), { passive: false });
            
            const inner = document.createElement('div');
            inner.className = 'cell-inner';
            inner.textContent = this.formatNumber(this.grid[x][y].number);
            cell.appendChild(inner);
            
            gridDiv.appendChild(cell);
          }
        }
        
        document.addEventListener('mousemove', (e) => this.handleMove(e));
        document.addEventListener('touchmove', (e) => this.handleMove(e), { passive: false });
        document.addEventListener('mouseup', () => this.handleEnd());
        document.addEventListener('touchend', () => this.handleEnd());
        
        this.updateXPBar();
      }
      
      handleCellStart(e, x, y) {
        e.preventDefault();
        if (this.gameState !== 'playing') return;
        
        if (this.activeBonus === 'destroy') {
          this.useDestroyBonus(x, y);
          return;
        }
        
        if (this.activeBonus === 'explosion') {
          this.useExplosionBonus(x, y);
          return;
        }
        
        if (this.isDragging) return;
        
        this.selected = [{x, y}];
        this.chainNumbers = [this.grid[x][y].number];
        this.isDragging = true;
        this.render();
      }
      
      handleMove(e) {
        if (!this.isDragging || this.activeBonus) return;
        
        e.preventDefault();
        const clientX = e.clientX || (e.touches && e.touches[0].clientX);
        const clientY = e.clientY || (e.touches && e.touches[0].clientY);
        
        if (!clientX || !clientY) return;
        
        const element = document.elementFromPoint(clientX, clientY);
        if (element && element.classList.contains('cell')) {
          const x = parseInt(element.dataset.x);
          const y = parseInt(element.dataset.y);
          
          this.handleCellHover(x, y);
        }
      }
      
      handleCellHover(x, y) {
        if (!this.isDragging || this.activeBonus) return;
        
        if (this.selected.some(sel => sel.x === x && sel.y === y)) return;
        
        const last = this.selected[this.selected.length - 1];
        if (!this.isAdjacent(last, {x, y})) return;
        
        const newNum = this.grid[x][y].number;
        const prevNum = this.chainNumbers[this.chainNumbers.length - 1];
        if (newNum === prevNum || newNum === prevNum * 2 || prevNum === newNum * 2) {
          this.selected.push({x, y});
          this.chainNumbers.push(newNum);
          this.render();
        }
      }
      
      handleEnd() {
        if (!this.isDragging) return;
        
        if (this.selected.length >= 2) {
          this.mergeChain();
        } else {
          this.selected = [];
          this.chainNumbers = [];
          this.render();
        }
        
        this.isDragging = false;
      }
      
      isAdjacent(a, b) {
        return Math.abs(a.x - b.x) <= 1 && Math.abs(a.y - b.y) <= 1;
      }
      
      mergeChain() {
        const last = this.selected[this.selected.length - 1];
        const newValue = this.chainNumbers.reduce((sum, val) => sum + val, 0);
        
        if (!this.isValidResultNumber(newValue)) {
          this.showLoveMessage("–°–ø—Ä–æ–±—É–π —ñ–Ω—à—É –∫–æ–º–±—ñ–Ω–∞—Ü—ñ—é, –∫–æ—Ö–∞–Ω–∞! üíï");
          this.selected = [];
          this.chainNumbers = [];
          this.render();
          return;
        }
        
        this.grid[last.x][last.y].number = newValue;
        this.grid[last.x][last.y].merged = true;
        
        for (let i = 0; i < this.selected.length - 1; i++) {
          const {x, y} = this.selected[i];
          this.grid[x][y].number = this.getRandomInitialNumber();
          this.grid[x][y].merged = false;
        }
        
        const xpEarned = this.calculateXP(this.selected.length);
        this.xp += xpEarned;
        
        this.showRandomLoveMessage(this.selected.length);
        
        if (newValue > this.maxNumber) {
          this.maxNumber = newValue;
        }
        
        setTimeout(() => {
          for (let x = 0; x < this.GRID_W; x++) {
            for (let y = 0; y < this.GRID_H; y++) {
              this.grid[x][y].merged = false;
            }
          }
          
          this.render();
          this.checkWin();
        }, 350);
        
        this.selected = [];
        this.chainNumbers = [];
        this.render();
        this.updateInfo();
        this.updateBonusButtons();
      }
      
      showRandomLoveMessage(chainLength) {
        this.messageCount++;
        document.getElementById('messageCount').textContent = this.messageCount;
        
        let message;
        if (chainLength >= 6) {
          message = "–í–∞—É! –¢–∏ –≥–µ–Ω—ñ–π –∫–æ—Ö–∞–Ω–Ω—è! üíñ –ù–∞—à–∞ –ª—é–±–æ–≤ —Ç–∞–∫–∞ –∂ —Å–∏–ª—å–Ω–∞!";
        } else if (chainLength >= 4) {
          message = "–ß—É–¥–æ–≤–æ! –ù–∞—à–∞ –ª—é–±–æ–≤ —Ä–æ—Å—Ç–µ —è–∫ —Ç–≤–æ—ó –Ω–∞–≤–∏—á–∫–∏! üåü";
        } else {
          const randomIndex = Math.floor(Math.random() * this.loveMessages.length);
          message = this.loveMessages[randomIndex];
        }
        
        this.showLoveMessage(message);
        this.createHeartsAnimation();
      }
      
      showLoveMessage(text) {
        const messageEl = document.getElementById('messageText');
        messageEl.classList.remove('fade-in');
        setTimeout(() => {
          messageEl.textContent = text;
          messageEl.classList.add('fade-in');
        }, 100);
      }
      
      createHeartsAnimation() {
        const heartsContainer = document.getElementById('hearts');
        heartsContainer.innerHTML = '';
        const heartCount = 5;
        
        for (let i = 0; i < heartCount; i++) {
          const heart = document.createElement('div');
          heart.className = 'heart';
          heart.innerHTML = '‚ù§Ô∏è';
          heart.style.left = Math.random() * 80 + 10 + '%';
          heart.style.animationDelay = Math.random() * 0.5 + 's';
          heartsContainer.appendChild(heart);
        }
      }
      
      formatNumber(num) {
        if (num >= 1_000_000_000) return (num/1_000_000_000).toFixed(num % 1_000_000_000 === 0 ? 0 : 1) + "B";
        if (num >= 1_000_000) return (num/1_000_000).toFixed(num % 1_000_000 === 0 ? 0 : 1) + "M";
        if (num >= 10_000) return (num/1_000).toFixed(0) + "–ö";
        if (num >= 1_000) return (num/1_000).toFixed(num % 1_000 === 0 ? 0 : 1) + "–ö";
        return num;
      }
      
      isValidResultNumber(num) {
        const level = this.levels[this.currentLevel];
        return level.numbers.includes(num) || level.newNumbers.includes(num);
      }
      
      getRandomInitialNumber() {
        const level = this.levels[this.currentLevel];
        return level.numbers[Math.floor(Math.random() * level.numbers.length)];
      }
      
      calculateXP(chainLen) {
        if (chainLen === 2) return 1;
        if (chainLen === 3) return 4;
        if (chainLen === 4) return 8;
        if (chainLen === 5) return 15;
        if (chainLen >= 6) return 25;
        return 0;
      }
      
      updateXPBar() {
        const percent = Math.min(1, this.xp / this.xpToNext);
        document.getElementById('xpBar').style.width = (percent * 100) + '%';
        document.getElementById('xpText').textContent = `${this.xp}/${this.xpToNext}`;
      }
      
      updateInfo() {
        const level = this.levels[this.currentLevel];
        document.getElementById('currentLevel').textContent = this.currentLevel + 1;
        document.getElementById('targetValue').textContent = this.formatNumber(level.target);
      }
      
      activateBonus(bonusType) {
        if (this.activeBonus === bonusType) {
          this.activeBonus = null;
          this.updateBonusButtons();
          this.render();
          return;
        }
        
        if (this.xp < this.bonusCosts[bonusType]) {
          this.showLoveMessage("–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –æ—á–∫—ñ–≤ –∫–æ—Ö–∞–Ω–Ω—è! ‚ù§Ô∏è‚Äçüî•");
          return;
        }
        
        if (bonusType === 'shuffle') {
          this.xp -= this.bonusCosts.shuffle;
          this.shuffleGrid();
          this.showLoveMessage("–ü–æ–ª–µ –ø–µ—Ä–µ–º—ñ—à–∞–Ω–æ –∑ –ª—é–±–æ–≤'—é! üí´");
          this.updateBonusButtons();
          return;
        }
        
        this.activeBonus = bonusType;
        this.updateBonusButtons();
        this.render();
        this.showLoveMessage("–ë–æ–Ω—É—Å –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ! üí´");
      }
      
      shuffleGrid() {
        const all = [];
        for (let x = 0; x < this.GRID_W; x++) {
          for (let y = 0; y < this.GRID_H; y++) {
            all.push(this.grid[x][y].number);
          }
        }
        
        for (let i = all.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [all[i], all[j]] = [all[j], all[i]];
        }
        
        let k = 0;
        for (let x = 0; x < this.GRID_W; x++) {
          for (let y = 0; y < this.GRID_H; y++) {
            this.grid[x][y].number = all[k++];
          }
        }
        
        this.render();
      }
      
      useDestroyBonus(x, y) {
        this.grid[x][y].number = this.getRandomInitialNumber();
        this.xp -= this.bonusCosts.destroy;
        this.activeBonus = null;
        this.updateBonusButtons();
        this.render();
        this.updateInfo();
        this.showLoveMessage("–ö–ª—ñ—Ç–∏–Ω–∫—É —Ä–æ–∑–±–∏—Ç–æ –∑ –ª—é–±–æ–≤'—é! üíñ");
      }
      
      useExplosionBonus(x, y) {
        for (let dx = -1; dx <= 1; dx++) {
          for (let dy = -1; dy <= 1; dy++) {
            const nx = x + dx;
            const ny = y + dy;
            
            if (nx >= 0 && nx < this.GRID_W && ny >= 0 && ny < this.GRID_H) {
              this.grid[nx][ny].number = this.getRandomInitialNumber();
            }
          }
        }
        
        this.xp -= this.bonusCosts.explosion;
        this.activeBonus = null;
        this.updateBonusButtons();
        this.render();
        this.updateInfo();
        this.showLoveMessage("–í–∏–±—É—Ö –∫–æ—Ö–∞–Ω–Ω—è! üí•‚ù§Ô∏è");
      }
      
      updateBonusButtons() {
        const bonuses = ['destroy', 'shuffle', 'explosion'];
        
        bonuses.forEach(bonus => {
          const btn = document.getElementById(`bonus-${bonus}`);
          const cost = this.bonusCosts[bonus];
          
          if (this.activeBonus === bonus) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
          
          if (this.xp < cost && this.activeBonus !== bonus) {
            btn.disabled = true;
          } else {
            btn.disabled = false;
          }
        });
      }
      
      showLevelSelect() {
        const sel = document.getElementById('level-select');
        sel.innerHTML = "";
        
        for (let i = 0; i < this.levels.length; i++) {
          const btn = document.createElement('button');
          btn.className = "level-btn";
          btn.textContent = i + 1;
          
          if (i === this.currentLevel) {
            btn.classList.add("selected");
          }
          
          btn.addEventListener('click', () => {
            this.currentLevel = i;
            this.initGame(i);
          });
          
          sel.appendChild(btn);
        }
      }
      
      autoNextLevel() {
        if (this.currentLevel < this.MAX_LEVEL - 1) {
          setTimeout(() => {
            this.showLoveMessage(`–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –ø–µ—Ä–µ—Ö—ñ–¥ –Ω–∞ —Ä—ñ–≤–µ–Ω—å ${this.currentLevel + 2} —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥–∏... ‚è±Ô∏è`);
            setTimeout(() => {
              this.initGame(this.currentLevel + 1);
              this.showLoveMessage(`–†—ñ–≤–µ–Ω—å ${this.currentLevel + 1}! –ù–æ–≤—ñ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ! üöÄ`);
            }, 3000);
          }, 2000);
        } else {
          setTimeout(() => {
            this.showVictoryScreen();
          }, 2000);
        }
      }
      
      checkWin() {
        const level = this.levels[this.currentLevel];
        
        for (let x = 0; x < this.GRID_W; x++) {
          for (let y = 0; y < this.GRID_H; y++) {
            if (this.grid[x][y].number === level.target) {
              this.gameState = 'win';
              this.showLoveMessage(`–í—ñ—Ç–∞—é! –¢–∏ –¥–æ—Å—è–≥–ª–∞ —Ü—ñ–ª—ñ ${this.formatNumber(level.target)}! üéâ‚ù§Ô∏è`);
              this.autoNextLevel();
              return;
            }
          }
        }
        
        if (this.xp >= this.xpToNext) {
          this.showLoveMessage("–¢–∏ –≥–æ—Ç–æ–≤–∞ –¥–æ –Ω–æ–≤–æ–≥–æ —Ä—ñ–≤–Ω—è –∫–æ—Ö–∞–Ω–Ω—è! üíñ");
        }
      }
      
      nextLevel() {
        if (this.currentLevel < this.MAX_LEVEL - 1) {
          if (this.xp >= this.xpToNext) {
            this.initGame(this.currentLevel + 1);
            this.showLoveMessage(`–†—ñ–≤–µ–Ω—å ${this.currentLevel + 1}! –ù–æ–≤—ñ –≤–∏–∫–ª–∏–∫–∏! üåü`);
          } else {
            this.showLoveMessage(`–ü–æ—Ç—Ä—ñ–±–Ω–æ ${this.xpToNext} –æ—á–∫—ñ–≤ –∫–æ—Ö–∞–Ω–Ω—è! ‚ù§Ô∏è`);
          }
        } else {
          this.showVictoryScreen();
        }
      }
      
      resetGame() {
        this.initGame(this.currentLevel);
      }
      
      saveGameState() {
        const gameData = {
          level: this.currentLevel,
          xp: this.xp,
          messages_unlocked: this.messageCount,
          max_level_reached: Math.max(this.currentLevel, this.loadGameState().max_level_reached || 0),
          timestamp: new Date().toISOString()
        };
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
        localStorage.setItem('love_puzzle_save', JSON.stringify(gameData));
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram –µ—Å–ª–∏ –≤ WebView
        if (this.isTelegram) {
          this.tg.sendData(JSON.stringify({
            action: 'save_game',
            game_data: gameData
          }));
        }
        
        this.showLoveMessage("–ü—Ä–æ–≥—Ä–µ—Å—Å –∑–±–µ—Ä–µ–∂–µ–Ω–æ! üíæ");
      }
      
      loadGameState() {
        try {
          const saved = localStorage.getItem('love_puzzle_save');
          if (saved) {
            const data = JSON.parse(saved);
            this.currentLevel = data.level || 0;
            this.xp = data.xp || 0;
            this.messageCount = data.messages_unlocked || 0;
            return data;
          }
        } catch (e) {
          console.log('No saved game found');
        }
        return {};
      }
      
      shareGame() {
        const shareText = `–Ø –≥—Ä–∞—é –≤ Love Number Puzzle! üéÆüíñ\n–î–æ—Å—è–≥–Ω—É—Ç–∞ —É—Ä–æ–≤–Ω—è ${this.currentLevel + 1} —ñ –≤—ñ–¥–∫—Ä–∏–ª–∞ ${this.messageCount} –ª—é–±–æ–≤–Ω–∏—Ö –ø–æ—Å–ª–∞–Ω—å!`;
        
        if (this.isTelegram) {
          this.tg.openTelegramLink(`https://t.me/share/url?url=https://t.me/YourBotUsername&text=${encodeURIComponent(shareText)}`);
        } else if (navigator.share) {
          navigator.share({
            title: 'Love Number Puzzle',
            text: shareText,
            url: 'https://t.me/YourBotUsername'
          });
        } else {
          this.showLoveMessage("–°–∫–æ–ø—ñ—é–π—Ç–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –±–æ—Ç–∞: https://t.me/YourBotUsername");
        }
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      new LoveNumberPuzzle();
    });
  </script>
</body>
</html>