<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Love Number Puzzle - –î–ª—è –º–æ—î—ó –∫–æ—Ö–∞–Ω–æ—ó</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://telegram.org/js/telegram-web-app.js?2"></script>
  <style>
    .romantic-particle { position: fixed; pointer-events: none; font-size: 1.5rem; z-index: 1000; animation: romanticFloat 3s ease-in-out forwards; }
    @keyframes romanticFloat { 0% { transform: translateY(0) rotate(0deg) scale(1); opacity: 1; } 100% { transform: translateY(-100px) rotate(360deg) scale(0.5); opacity: 0; } }
    .romantic-subtitle { font-size: 1.2rem; color: #e91e63; margin-bottom: 2rem; text-align: center; font-weight: bold; }
    .swipe-hint { text-align: center; color: #e91e63; font-weight: bold; margin: 10px 0; font-size: 0.9rem; }
    .touch-glow { position: fixed; width: 80px; height: 80px; background: radial-gradient(circle, rgba(255,107,107,0.6) 0%, rgba(255,107,107,0) 70%); border-radius: 50%; pointer-events: none; z-index: 999; animation: touchPulse 0.6s ease-out forwards; transform: translate(-50%, -50%); }
    @keyframes touchPulse { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(2); opacity: 0; } }
    body { background: linear-gradient(135deg, #ffafbd 0%, #ffc3a0 100%) !important; font-family: 'Arial', sans-serif; margin: 0; padding: 0; overflow: hidden; touch-action: pan-y; }
    .game-title { background: linear-gradient(45deg, #e91e63, #ff4081); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-shadow: 2px 2px 4px rgba(0,0,0,0.1); }
    .cell { transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(233, 30, 99, 0.2); user-select: none; }
    .cell.selected { transform: scale(0.9); box-shadow: 0 0 15px rgba(255, 64, 129, 0.6); z-index: 10; }
    .grid { display: grid; grid-template-columns: repeat(5, 1fr); grid-template-rows: repeat(8, 1fr); gap: 4px; width: 100%; height: 100%; touch-action: none; }
    .cell-inner { display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; font-weight: bold; font-size: 1.4rem; }
  </style>
</head>
<body>
  <div class="floating-hearts" id="floatingHearts"></div>
  <div id="romanticParticles"></div>

  <!-- Victory Overlay -->
  <div class="victory-overlay hidden" id="victoryOverlay">
    <div class="victory-content">
      <div class="victory-title">–ú–æ—è –ª—é–±–æ–≤!</div>
      <div class="victory-message" id="victoryMessage">–¢–∏ –ø—Ä–æ–π—à–ª–∞ –≤—Å—ñ —Ä—ñ–≤–Ω—ñ! –¢–∏ –Ω–∞–π–∫—Ä–∞—â–∞ –¥—Ä—É–∂–∏–Ω–∞ —É —Å–≤—ñ—Ç—ñ!</div>
      <div class="menu-buttons">
        <button class="menu-btn" id="playAgainBtn">–ì—Ä–∞—Ç–∏ –∑–Ω–æ–≤—É</button>
        <button class="menu-btn secondary" id="closeWebAppBtn">–ü–æ—Ü—ñ–ª—É–Ω–æ–∫</button>
      </div>
    </div>
  </div>

  <!-- Main Menu -->
  <div class="screen" id="mainMenuScreen">
    <div class="game-title">Love Puzzle</div>
    <div class="romantic-subtitle">–î–ª—è –º–æ—î—ó –Ω–∞–π–∫—Ä–∞—â–æ—ó –¥—Ä—É–∂–∏–Ω–∏</div>
    <div class="menu-buttons">
      <button class="menu-btn" id="playBtn">–ü–æ—á–∞—Ç–∏ –≥—Ä—É –∫–æ—Ö–∞–Ω–Ω—è</button>
      <button class="menu-btn secondary" id="settingsBtn">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</button>
      <button class="menu-btn secondary" id="aboutBtn">–ü—Ä–æ –Ω–∞—à–µ –∫–æ—Ö–∞–Ω–Ω—è</button>
    </div>
  </div>

  <!-- Game Screen -->
  <div class="screen game-screen hidden" id="gameScreen">
    <div class="game-header">
      <div class="header-top">
        <button class="home-btn" id="homeBtn">–î–æ–¥–æ–º—É</button>
        <div class="header">–ú–æ—è –ª—é–±–æ–≤, —è —Ç–µ–±–µ –æ–±–æ–∂–Ω—é—é!</div>
      </div>
      <div class="love-message">
        <div class="hearts" id="hearts"></div>
        <div class="message-text" id="messageText">–ü—Ä–æ–≤–µ–¥–∏ –ø–∞–ª—å—á–∏–∫–æ–º –ø–æ —á–∏—Å–ª–∞—Ö!</div>
      </div>
      <div class="stats">
        <div class="stat-item">–†—ñ–≤–µ–Ω—å: <span id="currentLevel">1</span>/30</div>
        <div class="stat-item">–¶—ñ–ª—å: <span id="targetValue">64</span></div>
        <div class="stat-item">–§—Ä–∞–∑: <span id="messageCount">0</span></div>
      </div>
    </div>
    <div class="xp-bar"><div class="xp-bar-inner" id="xpBar"><div class="xp-bar-text" id="xpText">0/10</div></div></div>
    <div class="game-content">
      <div class="bonuses">
        <button class="bonus-btn" id="bonus-destroy">–†–æ–∑–±–∏—Ç–∏ <span class="bonus-cost">5</span></button>
        <button class="bonus-btn" id="bonus-shuffle">–ü–µ—Ä–µ–º—ñ—à–∞—Ç–∏ <span class="bonus-cost">10</span></button>
        <button class="bonus-btn" id="bonus-explosion">–í–∏–±—É—Ö –∫–æ—Ö–∞–Ω–Ω—è <span class="bonus-cost">20</span></button>
      </div>
      <div class="swipe-hint">–ü—Ä–æ–≤–µ–¥–∏ –ø–∞–ª—å—Ü–µ–º –ø–æ —á–∏—Å–ª–∞—Ö –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –ª–∞–Ω—Ü—é–∂–∫–∞</div>
      <div class="grid-container"><div class="grid" id="grid"></div></div>
      <div class="controls">
        <button class="btn back-btn" id="backBtn">–î–æ –∫–æ—Ö–∞–Ω–æ—ó</button>
        <button class="btn" id="resetBtn">–ü–æ—á–∞—Ç–∏ –∑–Ω–æ–≤—É</button>
        <button class="btn" id="nextLevelBtn">–î–∞–ª—ñ –¥–æ —â–∞—Å—Ç—è</button>
      </div>
    </div>
  </div>

  <!-- Settings & About ‚Äî –±–µ–∑ –∑–º—ñ–Ω -->
  <div class="screen settings-screen hidden" id="settingsScreen">...</div>
  <div class="screen settings-screen hidden" id="aboutScreen">...</div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      let tg = null;
      let isTelegram = false;
      try {
        if (window.Telegram && window.Telegram.WebApp) {
          tg = window.Telegram.WebApp;
          tg.expand();
          tg.enableClosingConfirmation();
          isTelegram = true;
        }
      } catch(e) {}

      class LoveNumberPuzzle {
        constructor() {
          this.GRID_W = 5;
          this.GRID_H = 8;
          this.levels = this.generateLevels(30);
          this.MAX_LEVEL = this.levels.length;
          this.currentLevel = 0;
          this.grid = [];
          this.selected = [];
          this.chainNumbers = [];
          this.isDragging = false;
          this.lastCell = null;
          this.xp = 0;
          this.xpToNext = 10;
          this.maxNumber = 8;
          this.activeBonus = null;
          this.gameState = 'playing';
          this.messageCount = 0;

          this.bonusCosts = { destroy: 5, shuffle: 10, explosion: 20 };

          this.loveMessages = [
            "–¢–∏ - –º–æ—î —Å–æ–Ω–µ—á–∫–æ, —â–æ –æ—Å–≤—ñ—Ç–ª—é—î –∫–æ–∂–µ–Ω –º—ñ–π –¥–µ–Ω—å",
            "–ö–æ—Ö–∞–Ω–Ω—è –¥–æ —Ç–µ–±–µ –∑ –∫–æ–∂–Ω–∏–º –¥–Ω–µ–º —Å—Ç–∞—î —Å–∏–ª—å–Ω—ñ—à–∏–º",
            "–¢–≤–æ—ó –æ—á—ñ - —Ü–µ –∑—ñ—Ä–∫–∏, —â–æ –≤–∫–∞–∑—É—é—Ç—å –º–µ–Ω—ñ —à–ª—è—Ö",
            "–ó —Ç–æ–±–æ—é –∫–æ–∂–Ω–∞ –º–∏—Ç—å - —Ü–µ –∫–∞–∑–∫–∞",
            "–¢–∏ - –Ω–∞–π–Ω—ñ–∂–Ω—ñ—à–∞ –º—Ä—ñ—è –º–æ—î—ó –¥—É—à—ñ",
            "–¢–≤–æ—ó –æ–±—ñ–π–º–∏ - –º—ñ–π —É–ª—é–±–ª–µ–Ω–∏–π –∑–∞—Ö–∏—Å—Ç",
            "–ö–æ–∂–Ω–∞ —á–∞—Å—Ç–∏–Ω–∫–∞ —Ç–µ–±–µ —á–∞—Ä—ñ–≤–Ω–∞",
            "–¢–∏ —Ä–æ–±–∏—à –º–æ—î –∂–∏—Ç—Ç—è —Å–æ–ª–æ–¥—à–∏–º",
            "–¢–∏ - –º–æ—è —É–ª—é–±–ª–µ–Ω–∞ –ø–∞–Ω–¥–∞ —Å–µ—Ä–µ–¥ —É—Å—ñ—Ö –ø–∞–Ω–¥",
            "–õ—é–±–ª—é —Ç–µ–±–µ —Å–∏–ª—å–Ω—ñ—à–µ, –Ω—ñ–∂ –∫–æ—Ç–∏ –ª—é–±–ª—è—Ç—å –∫–æ—Ä–æ–±–∫–∏",
            "–¢–∏ - –º–æ—î —â–∞—Å—Ç—è, —è–∫ –º–æ—Ä–æ–∑–∏–≤–æ –≤ —Å–ø–µ–∫–æ—Ç–Ω–∏–π –¥–µ–Ω—å",
            "–¢–≤–æ—è –ø–æ—Å–º—ñ—à–∫–∞ - –Ω–∞–π–∫—Ä–∞—Å–∏–≤—ñ—à–∏–π –ø–µ–π–∑–∞–∂",
            "–õ—é–±–æ–≤ –¥–æ —Ç–µ–±–µ - –≤—ñ—á–Ω–∞ —ñ –±–µ–∑–º–µ–∂–Ω–∞",
            "–¢–∏ - –º—ñ–π —Å–ø–æ–∫—ñ–π —Å–µ—Ä–µ–¥ –±—É—Ä—ñ",
            "–ó —Ç–æ–±–æ—é —è –∑–Ω–∞–π—à–æ–≤ —Å–ø—Ä–∞–≤–∂–Ω—î —â–∞—Å—Ç—è",
            "–¢–≤–æ—î —Å–µ—Ä—Ü–µ - –º—ñ–π –Ω–∞–π—Ü—ñ–Ω–Ω—ñ—à–∏–π —Å–∫–∞—Ä–±",
            "–ö–æ–∂–Ω–∞ –º–∏—Ç—å –∑ —Ç–æ–±–æ—é - —Ü–µ –ø–æ–¥–∞—Ä—É–Ω–æ–∫",
            "–¢–∏ —Ä–æ–±–∏—à –º–æ—î –∂–∏—Ç—Ç—è —è—Å–∫—Ä–∞–≤—ñ—à–∏–º",
            "–ú–æ—î –∫–æ—Ö–∞–Ω–Ω—è –¥–æ —Ç–µ–±–µ –±–µ–∑–º–µ–∂–Ω–µ, —è–∫ –æ–∫–µ–∞–Ω",
            "–¢–∏ - –ø—Ä–∏—á–∏–Ω–∞ –º–æ—î—ó –ø–æ—Å–º—ñ—à–∫–∏ –∫–æ–∂–Ω–æ–≥–æ –¥–Ω—è",
            "–¢–≤–æ—è –ª—é–±–æ–≤ - –Ω–∞–π–∫—Ä–∞—â–µ, —â–æ —Å—Ç–∞–ª–æ—Å—è –≤ –º–æ—î–º—É –∂–∏—Ç—Ç—ñ",
            "–ó —Ç–æ–±–æ—é —è –º–æ–∂—É –¥–æ—Å—è–≥—Ç–∏ –±—É–¥—å-—á–æ–≥–æ!",
            "–¢–∏ - –º–æ—è –º—É–∑–∞ —Ç–∞ –Ω–∞—Ç—Ö–Ω–µ–Ω–Ω—è",
            "–ö–æ–∂–µ–Ω –¥–µ–Ω—å –∑ —Ç–æ–±–æ—é - —Ü–µ –Ω–æ–≤–∞ –ø—Ä–∏–≥–æ–¥–∞",
            "–¢–∏ - –º–æ—è —Ç–∏—Ö–∞ –≥–∞–≤–∞–Ω—å —É –±—É—Ä—Ö–ª–∏–≤–æ–º—É –º–æ—Ä—ñ",
            "–õ—é–±–ª—é —Ç–µ–±–µ –±—ñ–ª—å—à–µ, –Ω—ñ–∂ —Å–ª–æ–≤–∞ –º–æ–∂—É—Ç—å –ø–µ—Ä–µ–¥–∞—Ç–∏",
            "–¢–∏ - –º—ñ–π —â–∞—Å–ª–∏–≤–∏–π –∫–≤–∏—Ç–æ–∫ —É –∂–∏—Ç—Ç—ñ",
            "–ó —Ç–æ–±–æ—é –∫–æ–∂–µ–Ω –¥–µ–Ω—å - —Å–≤—è—Ç–æ",
            "–¢–∏ - –≤—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–∞ –≤—Å—ñ –º–æ—ó –º–æ–ª–∏—Ç–≤–∏",
            "–ú–æ—î —Å–µ—Ä—Ü–µ –Ω–∞–ª–µ–∂–∏—Ç—å —Ç–æ–±—ñ –Ω–∞–∑–∞–≤–∂–¥–∏",
            "–¢–∏ - –º–æ—è –¥—Ä—É–≥–∞ –ø–æ–ª–æ–≤–∏–Ω–∫–∞, —è–∫—É —è —à—É–∫–∞–≤ –≤—Å–µ –∂–∏—Ç—Ç—è",
            "–ö–æ–∂–Ω–∞ –∫–ª—ñ—Ç–∏–Ω–∫–∞ –º–æ–≥–æ —Ç—ñ–ª–∞ –ª—é–±–∏—Ç—å —Ç–µ–±–µ",
            "–¢–∏ - –º–æ—è –º—Ä—ñ—è, —è–∫–∞ –∑–±—É–ª–∞—Å—è",
            "–õ—é–±–ª—é —Ç–µ–±–µ –¥–æ –º—ñ—Å—è—Ü—è —ñ –Ω–∞–∑–∞–¥",
            "–¢–≤–æ—è –ª—é–±–æ–≤ - –º–æ—è –Ω–∞–π–±—ñ–ª—å—à–∞ —Å–∏–ª–∞",
            "–¢–∏ —Ä–æ–±–∏—à –º–æ—î –∂–∏—Ç—Ç—è —Å–ø—Ä–∞–≤–¥—ñ –∑–Ω–∞—á—É—â–∏–º",
            "–ú–æ—î –∫–æ—Ö–∞–Ω–Ω—è –¥–æ —Ç–µ–±–µ –±–µ–∑ —É–º–æ–≤ —ñ –∫–æ—Ä–¥–æ–Ω—ñ–≤",
            "–¢–∏ - –Ω–∞–π–∫—Ä–∞—â–∞ –¥—Ä—É–∂–∏–Ω–∞ —É –≤—Å—ñ–π –í—Å–µ—Å–≤—ñ—Ç—ñ",
            "–õ—é–±–ª—é —Ç–µ–±–µ –±—ñ–ª—å—à–µ, –Ω—ñ–∂ –≤—á–æ—Ä–∞, –∞–ª–µ –º–µ–Ω—à–µ, –Ω—ñ–∂ –∑–∞–≤—Ç—Ä–∞",
            "–¢–∏ - –º–æ—î –≤—Å–µ, –º–æ—è –ª—é–±–æ–≤, –º–æ—î –∂–∏—Ç—Ç—è",
            "–¢–≤–æ—è –ª—é–±–æ–≤ - —Ü–µ –º—É–∑–∏–∫–∞ –º–æ–≥–æ —Å–µ—Ä—Ü—è",
            "–¢–∏ - –Ω–∞–π–∫—Ä–∞—Å–∏–≤—ñ—à–∞ –∫–∞–∑–∫–∞ –º–æ–≥–æ –∂–∏—Ç—Ç—è",
            "–ú–æ—î –∫–æ—Ö–∞–Ω–Ω—è –¥–æ —Ç–µ–±–µ –Ω—ñ–∫–æ–ª–∏ –Ω–µ –∑–≥–∞—Å–Ω–µ"
          ];

          this.createEnhancedFloatingHearts();
          this.initEventListeners();
          this.showScreen('mainMenu');
        }

        createEnhancedFloatingHearts() {
          const container = document.getElementById('floatingHearts');
          const hearts = ['‚ù§Ô∏è','üíñ','üíï','üíó','üíì','üíû','üíò','üíù'];
          for (let i = 0; i < 20; i++) {
            const h = document.createElement('div');
            h.className = 'floating-heart';
            h.innerHTML = hearts[Math.floor(Math.random()*hearts.length)];
            h.style.left = Math.random()*100 + 'vw';
            h.style.top = Math.random()*100 + 'vh';
            h.style.animationDelay = Math.random()*8 + 's';
            h.style.fontSize = (0.8 + Math.random()) + 'em';
            h.style.animationDuration = (15 + Math.random()*15) + 's';
            container.appendChild(h);
          }
        }

        createRomanticParticle(x, y, emoji = 'üíñ') {
          const p = document.createElement('div');
          p.className = 'romantic-particle';
          p.innerHTML = emoji;
          p.style.left = x + 'px';
          p.style.top = y + 'px';
          document.getElementById('romanticParticles').appendChild(p);
          setTimeout(() => p.remove(), 3000);
        }

        createTouchGlow(x, y) {
          const g = document.createElement('div');
          g.className = 'touch-glow';
          g.style.left = x + 'px';
          g.style.top = y + 'px';
          document.body.appendChild(g);
          setTimeout(() => g.remove(), 600);
        }

        initEventListeners() {
          const grid = document.getElementById('grid');

          const startHandler = (e) => {
            if (this.gameState !== 'playing') return;
            const touch = e.touches ? e.touches[0] : e;
            const cell = this.getCellFromPoint(touch.clientX, touch.clientY);
            if (!cell) return;

            e.preventDefault();
            this.isDragging = true;
            this.selected = [];
            this.chainNumbers = [];
            this.lastCell = null;
            this.handleCellStart(cell.x, cell.y, touch.clientX, touch.clientY);
          };

          const moveHandler = (e) => {
            if (!this.isDragging) return;
            const touch = e.touches ? e.touches[0] : e;
            const cell = this.getCellFromPoint(touch.clientX, touch.clientY);
            if (!cell) return;

            if (this.lastCell && (Math.abs(cell.x - this.lastCell.x) > 1 || Math.abs(cell.y - this.lastCell.y) > 1)) return;

            if (!this.lastCell || this.isAdjacent(this.lastCell, cell)) {
              if (!this.selected.some(s => s.x === cell.x && s.y === cell.y)) {
                this.handleCellHover(cell.x, cell.y, touch.clientX, touch.clientY);
              }
            }
          };

          const endHandler = () => {
            if (this.isDragging) {
              this.isDragging = false;
              if (this.selected.length >= 2) this.mergeChain();
              else this.clearSelection();
            }
          };

          grid.addEventListener('touchstart', startHandler, { passive: false });
          grid.addEventListener('touchmove', moveHandler, { passive: false });
          grid.addEventListener('touchend', endHandler);
          grid.addEventListener('mousedown', startHandler);
          grid.addEventListener('mousemove', moveHandler);
          grid.addEventListener('mouseup', endHandler);
          grid.addEventListener('mouseleave', endHandler);

          // –ö–Ω–æ–ø–∫–∏
          document.getElementById('playBtn').onclick = () => this.startGame();
          document.getElementById('homeBtn').onclick = () => this.showScreen('mainMenu');
          document.getElementById('backBtn').onclick = () => this.showScreen('mainMenu');
          document.getElementById('resetBtn').onclick = () => this.resetGame();
          document.getElementById('nextLevelBtn').onclick = () => this.nextLevel();
          document.getElementById('bonus-destroy').onclick = () => this.activateBonus('destroy');
          document.getElementById('bonus-shuffle').onclick = () => this.activateBonus('shuffle');
          document.getElementById('bonus-explosion').onclick = () => this.activateBonus('explosion');
          document.getElementById('playAgainBtn').onclick = () => { this.hideVictoryScreen(); this.startGame(); };
          document.getElementById('closeWebAppBtn').onclick = () => { if (isTelegram && tg) tg.close(); else this.showScreen('mainMenu'); };
        }

        getCellFromPoint(x, y) {
          const rect = document.getElementById('grid').getBoundingClientRect();
          const col = Math.floor((x - rect.left) / (rect.width / this.GRID_W));
          const row = Math.floor((y - rect.top) / (rect.height / this.GRID_H));
          if (col >= 0 && col < this.GRID_W && row >= 0 && row < this.GRID_H) return { x: col, y: row };
          return null;
        }

        isAdjacent(a, b) {
          return Math.abs(a.x - b.x) <= 1 && Math.abs(a.y - b.y) <= 1 && !(a.x === b.x && a.y === b.y);
        }

        handleCellStart(x, y, clientX, clientY) {
          if (this.activeBonus === 'destroy') { this.useDestroyBonus(x, y); return; }
          if (this.activeBonus === 'explosion') { this.useExplosionBonus(x, y); return; }

          this.selected = [{ x, y }];
          this.chainNumbers = [this.grid[x][y].number];
          this.lastCell = { x, y };
          this.render();
          this.createTouchGlow(clientX, clientY);
          this.createRomanticParticle(clientX, clientY, 'üíï');
        }

        handleCellHover(x, y, clientX, clientY) {
          const num = this.grid[x][y].number;
          const lastNum = this.chainNumbers[this.chainNumbers.length - 1];
          if (num === lastNum || num === lastNum * 2 || lastNum === num * 2) {
            this.selected.push({ x, y });
            this.chainNumbers.push(num);
            this.lastCell = { x, y };
            this.render();
            this.createRomanticParticle(clientX, clientY, 'üå∏');
          }
        }

        clearSelection() {
          this.selected = [];
          this.chainNumbers = [];
          this.lastCell = null;
          this.render();
        }

        mergeChain() {
          const sum = this.chainNumbers.reduce((a,b) => a+b, 0);
          const last = this.selected[this.selected.length - 1];

          if (!this.isValidResultNumber(sum)) {
            this.showLoveMessage("–°–ø—Ä–æ–±—É–π —ñ–Ω—à—É –∫–æ–º–±—ñ–Ω–∞—Ü—ñ—é, –∫–æ—Ö–∞–Ω–∞!");
            this.clearSelection();
            return;
          }

          this.grid[last.x][last.y].number = sum;
          for (let i = 0; i < this.selected.length - 1; i++) {
            const p = this.selected[i];
            this.grid[p.x][p.y].number = this.getRandomInitialNumber();
          }

          const xpEarned = this.calculateXP(this.selected.length);
          this.xp += xpEarned;
          this.messageCount++;
          document.getElementById('messageCount').textContent = this.messageCount;
          this.showRandomLoveMessage(this.selected.length);
          this.updateXPBar();
          this.updateBonusButtons();
          this.checkWin();

          setTimeout(() => this.clearSelection(), 400);
        }

        render() {
          const grid = document.getElementById('grid');
          grid.innerHTML = '';
          for (let y = 0; y < this.GRID_H; y++) {
            for (let x = 0; x < this.GRID_W; x++) {
              const cell = document.createElement('div');
              cell.className = 'cell';
              if (this.selected.some(s => s.x === x && s.y === y)) cell.classList.add('selected');
              const inner = document.createElement('div');
              inner.className = 'cell-inner';
              inner.textContent = this.formatNumber(this.grid[x][y].number);
              cell.appendChild(inner);
              grid.appendChild(cell);
            }
          }
        }

        showScreen(name) {
          document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
          document.getElementById(name + 'Screen')?.classList.remove('hidden');
        }

        startGame() { this.initGame(0); this.showScreen('game'); }

        initGame(level) {
          this.currentLevel = level;
          const lvl = this.levels[level];
          this.xp = 0;
          this.xpToNext = lvl.xpToNext;
          this.grid = Array.from({length: this.GRID_W}, () =>
            Array.from({length: this.GRID_H}, () => ({
              number: lvl.numbers[Math.floor(Math.random() * lvl.numbers.length)]
            }))
          );
          this.clearSelection();
          this.render();
          document.getElementById('currentLevel').textContent = level + 1;
          document.getElementById('targetValue').textContent = this.formatNumber(lvl.target);
          this.showLoveMessage("–û–±'—î–¥–Ω—É–π —á–∏—Å–ª–∞ —Ç–∞ –æ—Ç—Ä–∏–º—É–π –ª—é–±–æ–≤–Ω—ñ —Ñ—Ä–∞–∑–∏!");
        }

        generateLevels(n) {
          const levels = [];
          let target = 64;
          let bases = [2,4,8];
          for (let i = 0; i < n; i++) {
            levels.push({
              numbers: [...bases],
              target,
              newNumbers: this.generateNewNumbers(target),
              xpToNext: 10 + i * 2.5,
              max: bases[bases.length-1]
            });
            target *= 2;
            if (i % 3 === 2 && bases.length < 6) bases.push(bases[bases.length-1] * 2);
          }
          return levels;
        }

        generateNewNumbers(t) {
          const res = [];
          let n = t / 8;
          while (n <= t) { res.push(n); n *= 2; }
          return res;
        }

        formatNumber(n) {
          if (n >= 1e9) return (n/1e9).toFixed(1)+'B';
          if (n >= 1e6) return (n/1e6).toFixed(1)+'M';
          if (n >= 1e3) return (n/1e3).toFixed(0)+'–ö';
          return n;
        }

        isValidResultNumber(n) {
          const lvl = this.levels[this.currentLevel];
          return lvl.numbers.includes(n) || lvl.newNumbers.includes(n);
        }

        getRandomInitialNumber() {
          const lvl = this.levels[this.currentLevel];
          return lvl.numbers[Math.floor(Math.random() * lvl.numbers.length)];
        }

        calculateXP(len) {
          if (len >= 6) return 25;
          if (len >= 5) return 15;
          if (len >= 4) return 8;
          if (len >= 3) return 4;
          return 1;
        }

        showRandomLoveMessage(len) {
          let msg;
          if (len >= 6) msg = "–í–∞—É! –¢–∏ –≥–µ–Ω—ñ–π –∫–æ—Ö–∞–Ω–Ω—è! –ù–∞—à–∞ –ª—é–±–æ–≤ —Ç–∞–∫–∞ –∂ —Å–∏–ª—å–Ω–∞!";
          else if (len >= 4) msg = "–ß—É–¥–æ–≤–æ! –ù–∞—à–∞ –ª—é–±–æ–≤ —Ä–æ—Å—Ç–µ!";
          else msg = this.loveMessages[Math.floor(Math.random() * this.loveMessages.length)];
          this.showLoveMessage(msg);
          this.createHeartsAnimation();
        }

        showLoveMessage(t) { document.getElementById('messageText').textContent = t; }

        createHeartsAnimation() {
          const cont = document.getElementById('hearts');
          cont.innerHTML = '';
          for (let i = 0; i < 5; i++) {
            const h = document.createElement('div');
            h.className = 'heart';
            h.innerHTML = '‚ù§Ô∏è';
            h.style.left = (10 + Math.random()*80) + '%';
            h.style.animationDelay = Math.random()*0.5 + 's';
            cont.appendChild(h);
          }
        }

        updateXPBar() {
          const percent = Math.min(100, (this.xp / this.xpToNext) * 100);
          document.getElementById('xpBar').style.width = percent + '%';
          document.getElementById('xpText').textContent = `${this.xp}/${this.xpToNext}`;
        }

        updateBonusButtons() {
          ['destroy','shuffle','explosion'].forEach(b => {
            const btn = document.getElementById('bonus-' + b);
            const cost = this.bonusCosts[b];
            btn.classList.toggle('active', this.activeBonus === b);
            btn.disabled = this.xp < cost && this.activeBonus !== b;
          });
        }

        activateBonus(type) {
          if (this.activeBonus === type) { this.activeBonus = null; this.updateBonusButtons(); return; }
          if (this.xp < this.bonusCosts[type]) { this.showLoveMessage("–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –æ—á–∫—ñ–≤ –∫–æ—Ö–∞–Ω–Ω—è!"); return; }
          if (type === 'shuffle') {
            this.xp -= this.bonusCosts.shuffle;
            this.shuffleGrid();
            this.showLoveMessage("–ü–æ–ª–µ –ø–µ—Ä–µ–º—ñ—à–∞–Ω–æ –∑ –ª—é–±–æ–≤'—é!");
            this.updateBonusButtons();
            return;
          }
          this.activeBonus = type;
          this.updateBonusButtons();
          this.showLoveMessage("–ë–æ–Ω—É—Å –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ! –ù–∞—Ç–∏—Å–Ω–∏ –Ω–∞ –∫–ª—ñ—Ç–∏–Ω–∫—É");
        }

        shuffleGrid() {
          const nums = [];
          for (let x = 0; x < this.GRID_W; x++)
            for (let y = 0; y < this.GRID_H; y++)
              nums.push(this.grid[x][y].number);
          nums.sort(() => Math.random() - 0.5);
          let i = 0;
          for (let x = 0; x < this.GRID_W; x++)
            for (let y = 0; y < this.GRID_H; y++)
              this.grid[x][y].number = nums[i++];
          this.render();
        }

        useDestroyBonus(x, y) {
          this.grid[x][y].number = this.getRandomInitialNumber();
          this.xp -= this.bonusCosts.destroy;
          this.activeBonus = null;
          this.updateBonusButtons();
          this.render();
          this.showLoveMessage("–ö–ª—ñ—Ç–∏–Ω–∫—É —Ä–æ–∑–±–∏—Ç–æ –∑ –ª—é–±–æ–≤'—é!");
        }

        useExplosionBonus(x, y) {
          for (let dx = -1; dx <= 1; dx++)
            for (let dy = -1; dy <= 1; dy++) {
              const nx = x + dx, ny = y + dy;
              if (nx >= 0 && nx < this.GRID_W && ny >= 0 && ny < this.GRID_H)
                this.grid[nx][ny].number = this.getRandomInitialNumber();
            }
          this.xp -= this.bonusCosts.explosion;
          this.activeBonus = null;
          this.updateBonusButtons();
          this.render();
          this.showLoveMessage("–í–∏–±—É—Ö –∫–æ—Ö–∞–Ω–Ω—è!");
        }

        checkWin() {
          const target = this.levels[this.currentLevel].target;
          for (let x = 0; x < this.GRID_W; x++)
            for (let y = 0; y < this.GRID_H; y++)
              if (this.grid[x][y].number === target) {
                this.gameState = 'win';
                this.showLoveMessage(`–í—ñ—Ç–∞—é! –¢–∏ –¥–æ—Å—è–≥–ª–∞ ${this.formatNumber(target)}!`);
                this.autoNextLevel();
                return;
              }
          if (this.xp >= this.xpToNext) this.showLoveMessage("–ì–æ—Ç–æ–≤–∞ –¥–æ –Ω–æ–≤–æ–≥–æ —Ä—ñ–≤–Ω—è –∫–æ—Ö–∞–Ω–Ω—è!");
        }

        autoNextLevel() {
          setTimeout(() => {
            if (this.currentLevel < this.MAX_LEVEL - 1) {
              this.initGame(this.currentLevel + 1);
            } else {
              this.showVictoryScreen();
            }
          }, 2500);
        }

        nextLevel() {
          if (this.currentLevel < this.MAX_LEVEL - 1 && this.xp >= this.xpToNext) {
            this.initGame(this.currentLevel + 1);
          } else if (this.currentLevel >= this.MAX_LEVEL - 1) {
            this.showVictoryScreen();
          }
        }

        resetGame() { this.initGame(this.currentLevel); }

        showVictoryScreen() {
          document.getElementById('victoryMessage').textContent = `–¢–∏ –ø—Ä–æ–π—à–ª–∞ –≤—Å—ñ ${this.MAX_LEVEL} —Ä—ñ–≤–Ω—ñ–≤! –¢–∏ –Ω–∞–π–∫—Ä–∞—â–∞ –¥—Ä—É–∂–∏–Ω–∞ —É —Å–≤—ñ—Ç—ñ!`;
          document.getElementById('victoryOverlay').classList.remove('hidden');
        }

        hideVictoryScreen() {
          document.getElementById('victoryOverlay').classList.add('hidden');
        }
      }

      window.game = new LoveNumberPuzzle();
    });
  </script>
</body>
</html>